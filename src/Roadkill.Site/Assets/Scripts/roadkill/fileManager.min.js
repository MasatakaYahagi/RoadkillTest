var Roadkill;(function(n){(function(n){var r=function(){function n(){this._navigator=new i,$("#fileupload").fileupload({dropZone:$("#folder-container"),pasteZone:$("body"),dataType:"json",progressall:function(n,t){var i=t.loaded/t.total*100+"",r=parseInt(i,10);$("#progress .bar").css("width",r+"%")},done:function(n,t){if(t.result.status=="error"){alert(t.result.message);return}$.each(t.result.files,function(n,t){$("#files").append(this._navigator.getFileRowHtml(t))}),setTimeout(function(){$("#progress div.bar").css("width","0%")},2e3)}}).bind("fileuploaddrop",function(){this._navigator.setCurrentPath()});$("#addfolderbtn").on("click",this.addFolderInput);$("#deletefolderbtn").bind("click",this.deleteFolder),$("#deletefilebtn").bind("click",this.deleteFile),$("#newfolderinput").live("keyup",this.saveNewFolder),$("#newfoldercancel").live("click",this.cancelNewFolder)}return n.prototype.deleteFolder=function(){var n=this._navigator.getCurrentPath(),i;if(n==""){alert(ROADKILL_DELETE_BASEFOLDER_ERROR);return}(i=t.FormatString(ROADKILL_DELETE_CONFIRM,n),confirm(i))&&$.ajax({type:"POST",url:"filemanager/deletefolder",data:{folder:n},success:function(n){n.status=="ok"?this._navigator.navigatePriorBreadcrumb():alert(n.message)},dataType:"json"})},n.prototype.deleteFile=function(){var n=$("tr.select");if(n.length>0&&n.attr("data-itemtype")=="file"){var i=this._navigator.getCurrentPath(),r=$("td.file",n).text(),u=t.FormatString(ROADKILL_DELETE_CONFIRM,i+"/"+r);if(!confirm(u))return;$.ajax({type:"POST",url:"filemanager/deletefile",data:{filepath:i,filename:r},success:function(t){t.status=="ok"?$(n).remove():alert(t.message)},dataType:"json"})}},n.prototype.addFolderInput=function(){if($("tr#newfolderrow").length>0){$("#newfolderinput").focus();return}var t=$("table#files tr[data-itemtype=folder]"),n;n+='<tr id="newfolderrow">',n+='<td><img src="'+ROADKILL_COREASSETPATH+'CSS/images/directory.png"><\/td>',n+='<td><span><input id="newfolderinput" placeholder="New folder" /><\/span>',n+='<img id="newfoldercancel" title="Cancel New Folder" src="'+ROADKILL_COREASSETPATH+'CSS/images/cancel.png"><\/span>',n+='<span style="vertical-align:bottom;"><\/td>',n+='<td colspan="3"><\/td><\/tr>',t.length>0?(t=t.last(),$(n).insertAfter(t)):$("table#files").append(n),$("#newfolderinput").focus()},n.prototype.saveNewFolder=function(n){if(n.which==0||n.which==27)this.cancelNewFolder();else if(n.which==13){var t=$("#newfolderinput").val();if(t.replace(/\s/g,"").length==0){this.cancelNewFolder();return}$.ajax({type:"POST",url:"filemanager/newfolder",data:{currentFolderPath:this._navigator.getCurrentPath(),newFolderName:t},success:this.processNewFolder,dataType:"json"})}},n.prototype.cancelNewFolder=function(){$("tr#newfolderrow").remove()},n.prototype.processNewFolder=function(n){if(n.status=="error"){alert(n.message);return}var t=$("ul.navigator li:last-child");this._navigator.navigateBreadcrumb(t.attr("data-level"),t.attr("data-urlpath")),$("tr#newfolderrow").remove()},n}(),i,t;n.FileManager=r,i=function(){function n(){$("tr.listrow").live("mouseenter",function(){$(this).addClass("focus")}).live("mouseleave",function(){$(this).removeClass("focus")}).live("click",function(){this.handleRowSelection(this)}),this.imagePreviewInit(),this.navigatePath("")}return n.prototype.setCurrentPath=function(){var n=this.getCurrentPath();$("#destination_folder").val(n)},n.prototype.addBreadcrumb=function(n){var i=$("ul.navigator li").length,t;t+='<li data-level="'+i+'" data-urlpath="'+n.UrlPath+'">',t+='<a href="javascript:navigateBreadcrumb('+i+",&quot;"+encodeURI(n.UrlPath)+'&quot;)">',t+=n.Name+"<\/a>",t+="<\/li>",$("ul.navigator").append(t)},n.prototype.handleRowSelection=function(n){$(n).attr("data-itemtype")=="folder"?this.navigatePath($(n).attr("data-itemid")):($("table#files tr.select").removeClass("select"),$(n).addClass("select"),$("table#files").trigger("fileselected",{file:this.getCurrentPath()+"/"+$("td.file",n).text()}))},n.prototype.buildTableFolderView=function(n){for(var r=['<table id="files"><thead><tr><th colspan=2>Name<\/th><th>Date Uploaded<\/th><th>Type<\/th><th>Size<\/th><\/tr><\/thead>'],i,t=0;t<n.ChildFolders.length;t++)i+='<tr class="listrow" data-itemtype="folder" data-itemid="'+n.ChildFolders[t].UrlPath+'">',i+="<td width='1%'>",i+="<img src='"+ROADKILL_COREASSETPATH+"CSS/images/directory.png'><\/td>",i+='<td nowrap width="20%">'+n.ChildFolders[t].Name+"<\/td>",i+="<td><\/td>",i+="<td><\/td>",i+="<td><\/td>",i+="<\/tr>",r.push(i);for(t=0;t<n.Files.length;t++)r.push(this.getFileRowHtml(n.Files[t]));r.push("<\/table>"),$("#folder-container").empty().append(r.join(""))},n.prototype.getFileRowHtml=function(n){var i;return i+='<tr class="listrow" data-itemtype="file">',i+='<td width="1%">',i+='<img src="'+ROADKILL_COREASSETPATH+'CSS/images/file.png" >',i+="<\/td>",i+='<td class="file">{0}<\/td >',i+="<td>{1}<\/td>",i+='<td class="filetype">{2}<\/td>',i+='<td class="filesize">{3}<\/td>',i+="<\/tr> ",t.FormatString(i,n.Name,n.CreateDate,n.Extension,n.Size)},n.prototype.imagePreviewInit=function(){var n=20,t=20;$("table#files tr[data-itemtype=file]").live("mouseenter",function(i){var u,r;(u=$("td.filetype",this).text(),u.search(/^(jpg|png|gif)$/i)!=-1)&&(r=ROADKILL_ATTACHMENTSPATH+this.getCurrentPath()+"/",r=r.replace("//","/")+$("td.file",this).text(),$("body").append("<p id='image-preview'><img src='"+r+"' alt='Image Preview' /><\/p>"),$("#image-preview").css("top",i.pageY-n+"px").css("left",i.pageX+t+"px").fadeIn("fast"))}).live("mouseleave",function(){$("#image-preview").remove()}).live("mousemove",function(i){$("#preview").css("top",i.pageY-n+"px").css("left",i.pageX+t+"px")})},n.prototype.getCurrentPath=function(){return $("ul.navigator li:last").attr("data-urlpath")},n.prototype.navigateBreadcrumb=function(n,t){n==0?$("ul.navigator li").remove():$("ul.navigator li:gt("+(n-1)+")").remove(),this.navigatePath(t)},n.prototype.navigatePath=function(n){$.ajax({type:"POST",url:ROADKILL_FILEMANAGERURL+"/folderinfo",data:{dir:n},success:function(n){this.addBreadcrumb(n),this.buildTableFolderView(n),this.setCurrentPath()},dataType:"json"})},n.prototype.navigatePriorBreadcrumb=function(){var t=$("ul.navigator li").length;if(t!=1){var n=$("ul.navigator li:last-child").prev("li"),i=n.attr("data-level"),r=n.attr("data-urlpath");this.navigateBreadcrumb(i,r)}},n}(),t=function(){function n(){}return n.FormatString=function(n){for(var u=[],r,i,f,t=0;t<arguments.length-1;t++)u[t]=arguments[t+1];for(r=n,i=0;i<u.length;i++)f=new RegExp("\\{"+i+"\\}","gm"),r=r.replace(f,u[i]);return r},n}()})(n.Site||(n.Site={}));var t=n.Site})(Roadkill||(Roadkill={}))