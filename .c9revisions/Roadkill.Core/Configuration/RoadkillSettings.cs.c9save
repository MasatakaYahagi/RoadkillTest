{"ts":1353591891030,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"ï»¿using System;\r\nusing System.Collections.Generic;\r\nusing System.Linq;\r\nusing System.Web;\r\nusing System.Configuration;\r\nusing System.Web.Security;\r\nusing System.Web.Configuration;\r\nusing System.Reflection;\r\nusing System.IO;\r\nusing StructureMap;\r\n\r\nnamespace Roadkill.Core.Configuration\r\n{\r\n\t/// <summary>\r\n\t/// The default implementation of <see cref=\"IConfigurationContainer\"/>\r\n\t/// </summary>\r\n\tpublic class RoadkillSettings : IConfigurationContainer, IInjectionLaunderer\r\n\t{\r\n\t\tprivate SitePreferences _sitePreferences;\r\n\t\tprivate ApplicationSettings _applicationSettings;\r\n\r\n\t\t/// <summary>\r\n\t\t/// Retrieves the configuration settings that are stored in the database.\r\n\t\t/// </summary>\r\n\t\t/// <returns>A <see cref=\"SitePreferences\"/></returns>\r\n\t\tpublic SitePreferences SitePreferences\r\n\t\t{\r\n\t\t\tget \r\n\t\t\t{\r\n\t\t\t\tif (_sitePreferences == null)\r\n\t\t\t\t{\r\n\t\t\t\t\tLoadSitePreferences();\r\n\t\t\t\t}\r\n\r\n\t\t\t\treturn _sitePreferences; \r\n\t\t\t}\r\n\t\t\tset { _sitePreferences = value; }\r\n\t\t}\r\n\t\r\n\t\t/// <summary>\r\n\t\t/// Retrieves the configuration settings that are stored inside an application config \r\n\t\t/// file and require an application restart when changed.\r\n\t\t/// </summary>\r\n\t\t/// <returns>A <see cref=\"RoadkillSection\"/></returns>\r\n\t\tpublic ApplicationSettings ApplicationSettings\r\n\t\t{\r\n\t\t\tget\r\n\t\t\t{\r\n\t\t\t\tif (_applicationSettings == null)\r\n\t\t\t\t{\r\n\t\t\t\t\t_applicationSettings = new ApplicationSettings();\r\n\t\t\t\t\t_applicationSettings.Load();\r\n\t\t\t\t}\r\n\r\n\t\t\t\treturn _applicationSettings; \r\n\t\t\t}\r\n\t\t\tset { _applicationSettings = value; }\r\n\t\t}\r\n\r\n\t\tpublic static IConfigurationContainer Current\r\n\t\t{\r\n\t\t\tget\r\n\t\t\t{\r\n\t\t\t\treturn ObjectFactory.GetInstance<IConfigurationContainer>();\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tpublic virtual void LoadSitePreferences()\r\n\t\t{\r\n\t\t\tIRepository repository;\r\n\r\n\t\t\ttry\r\n\t\t\t{\r\n\t\t\t\trepository = ObjectFactory.GetInstance<IRepository>();\r\n\t\t\t}\r\n\t\t\tcatch (StructureMapException e)\r\n\t\t\t{\r\n\t\t\t\tthrow new IoCException(\"A StructureMap exception occurred when loading the repository for SitePreferences - has RoadkillApplication.SetupIoC() been called? \"\r\n\t\t\t\t\t+ ObjectFactory.WhatDoIHave(), e);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tSitePreferences preferences = repository.GetSitePreferences();\r\n\r\n\t\t\tif (preferences == null)\r\n\t\t\t\tthrow new DatabaseException(null, \"No configuration settings could be found in the database (id {0}). \" +\r\n\t\t\t\t\t\"Has SettingsManager.SaveSiteConfiguration() been called?\", SitePreferences.ConfigurationId);\r\n\r\n\t\t\tif (string.IsNullOrEmpty(preferences.AllowedFileTypes))\r\n\t\t\t\tthrow new InvalidOperationException(\"The allowed file types setting is empty\");\r\n\r\n\t\t\t_sitePreferences = preferences;\r\n\t\t}\r\n\t}\r\n}"]],"start1":0,"start2":0,"length1":0,"length2":2591}]],"length":2591}
